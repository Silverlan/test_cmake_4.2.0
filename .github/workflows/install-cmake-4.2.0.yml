name: Install CMake 4.2.0

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  setup-cmake:
    runs-on: ubuntu-25
    steps:
      - name: Checkout (optional)
        uses: actions/checkout@v4

      - name: Install libstdc++-15-dev
        run: |
          lsb_release -a
          cat /etc/os-release
          grep -R "ubuntu-toolchain-r" /etc/apt/sources.list.d/ -n
          apt policy | sed -n '1,120p'


          sudo add-apt-repository ppa:ubuntu-toolchain-r/test
          sudo apt update
          sudo apt install g++-15 libstdc++-15-dev
          find ~/ -type f -name "libstdc++.modules.json"


      - name: Download CMake 4.1.2
        run: |
          set -euo pipefail
          VERSION=4.1.2
          ASSET="cmake-${VERSION}-linux-x86_64.tar.gz"
          URL="https://github.com/Kitware/CMake/releases/download/v${VERSION}/${ASSET}"
          wget --quiet --show-progress "$URL" -O "$ASSET"
          
          VERSION=4.1.2
          ASSET="cmake-${VERSION}-linux-x86_64.tar.gz"
          sudo rm -rf /opt/cmake-${VERSION} || true
          sudo tar -C /opt -xzf "$ASSET"
          sudo mv /opt/cmake-${VERSION}-linux-x86_64 /opt/cmake-${VERSION} || true
          for bin in /opt/cmake-${VERSION}/bin/*; do
            sudo ln -sf "$bin" /usr/local/bin/$(basename "$bin")
          done

      - name: Verify installed CMake
        run: cmake --version
